<!doctype html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>Seattle Rain Trends â€” Interactive Dashboard</title>
  <script src='https://cdn.plot.ly/plotly-2.29.1.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js'></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; margin:0; padding:24px; background-color: #f4f7f6;}
    h1{margin:0 0 6px 0; text-align:center; color: #123C69;}
    p.sub{margin:0 0 16px 0; text-align:center; color:#666}
    .wrap{max-width:1100px; margin:0 auto}
    .card{background:#fff; border:1px solid #e6e6e6; border-radius:10px; padding:16px; margin:12px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    .row{display:flex; gap:16px; flex-wrap:wrap}
    .col{flex:1 1 520px}
    .note{background:#fffbe6; border:1px dashed #ffe58f; padding:12px; border-radius:8px; color:#856404; font-size: 0.9em;}
    select{padding:6px 12px; border-radius: 4px; border: 1px solid #ccc;}
  </style>
</head>
<body>
  <h1>Seattle Rain Trends (Sea-Tac)</h1>
  <p class='sub'>Interactive visualization of NOAA precipitation data</p>
  
  <div class='wrap'>
    <div id="error-box" class='card note' style="display:none; background:#fff1f0; border-color:#ffa39e; color:#cf1322;">
        <strong>Error:</strong> Files not found or data is empty. Check your GitHub Actions tab.
    </div>

    <div class='card'>
      <div style='display:flex; align-items:center; gap:12px; margin-bottom:8px;'>
        <label for='yearSel'><strong>Select Year:</strong></label>
        <select id='yearSel'></select>
      </div>
      <div id='monthlyChart' style='height:400px;'></div>
    </div>

    <div class='row'>
      <div class='card col'>
        <div id='annualTrend' style='height:400px;'></div>
      </div>
      <div class='card col'>
        <div id='monthlyHeat' style='height:400px;'></div>
      </div>
    </div>
  </div>

<script>
const MONTHS_ORDER = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
let monthlyData = [];
let annualData = [];

// Robust lookup for headers regardless of case (DATE vs date)
function getVal(row, keys) {
    const foundKey = Object.keys(row).find(k => keys.includes(k.toUpperCase()));
    return foundKey ? row[foundKey] : null;
}

function processMonthlyRow(row) {
    const dateVal = getVal(row, ['DATE', 'MONTH']);
    const precipVal = getVal(row, ['PRCP', 'PRECIP', 'VALUE']);
    if (!dateVal) return null;
    const dateParts = String(dateVal).split('-');
    return { Year: parseInt(dateParts[0]), Month: MONTHS_ORDER[parseInt(dateParts[1])-1], Precip: parseFloat(precipVal) || 0 };
}

function processAnnualRow(row) {
    const dateVal = getVal(row, ['DATE', 'YEAR']);
    const precipVal = getVal(row, ['PRCP', 'VALUE']);
    if (!dateVal) return null;
    return { Year: parseInt(String(dateVal).split('-')[0]), Precip: parseFloat(precipVal) || 0 };
}

function loadCSV(path){
  return new Promise((resolve,reject)=>{
    Papa.parse(path, {
      download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
      complete: results => resolve(results.data),
      error: err => reject(err)
    });
  });
}

function renderCharts(){
    // Year Selector
    const sel = document.getElementById('yearSel');
    const years = Array.from(new Set(monthlyData.map(d=>d.Year))).sort((a,b)=>b-a);
    sel.innerHTML = years.map(y=>`<option value='${y}'>${y}</option>`).join('');
    
    const updateMonthly = () => {
        const year = parseInt(sel.value);
        const rows = monthlyData.filter(d=>d.Year===year);
        const y = MONTHS_ORDER.map(m => (rows.find(r=>r.Month===m)?.Precip || 0));
        Plotly.newPlot('monthlyChart', [{ x: MONTHS_ORDER, y, type: 'bar', marker: {color:'#1B98E0'} }], { title: `Rainfall in ${year}` });
    };

    sel.onchange = updateMonthly;
    updateMonthly();

    // Annual Line Chart
    Plotly.newPlot('annualTrend', [{
        x: annualData.map(d=>d.Year),
        y: annualData.map(d=>d.Precip),
        type: 'scatter', mode: 'lines+markers', line: {color:'#123C69'}
    }], { title: 'Annual Totals', xaxis: {tickformat: 'd'} });

    // Heatmap
    const heatYears = Array.from(new Set(monthlyData.map(d=>d.Year))).sort();
    const z = heatYears.map(y => MONTHS_ORDER.map(m => monthlyData.find(d=>d.Year===y && d.Month===m)?.Precip || 0));
    Plotly.newPlot('monthlyHeat', [{ z, x: MONTHS_ORDER, y: heatYears, type: 'heatmap', colorscale: 'Blues' }], { title: 'Rain Intensity' });
}

window.addEventListener('DOMContentLoaded', () => {
    Promise.all([ loadCSV('seattle_rain_monthly.csv'), loadCSV('seattle_rain_annual.csv') ])
    .then(([mRaw, aRaw]) => {
        monthlyData = mRaw.map(processMonthlyRow).filter(d => d !== null);
        annualData = aRaw.map(processAnnualRow).filter(d => d !== null);
        if(!monthlyData.length) throw new Error("Empty Data");
        renderCharts();
    })
    .catch(err => {
        console.error(err);
        document.getElementById('error-box').style.display = 'block';
    });
});
</script>
</body>
</html>
