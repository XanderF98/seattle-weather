<!doctype html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>Seattle Rain Trends â€” Interactive Dashboard</title>
  <script src='https://cdn.plot.ly/plotly-2.29.1.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js'></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; margin:0; padding:24px; background-color: #f4f7f6;}
    h1{margin:0 0 6px 0; text-align:center; color: #123C69;}
    p.sub{margin:0 0 16px 0; text-align:center; color:#666}
    .wrap{max-width:1100px; margin:0 auto}
    .card{background:#fff; border:1px solid #e6e6e6; border-radius:10px; padding:16px; margin:12px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    .row{display:flex; gap:16px; flex-wrap:wrap}
    .col{flex:1 1 520px}
    .note{background:#fffbe6; border:1px dashed #ffe58f; padding:12px; border-radius:8px; color:#856404; font-size: 0.9em;}
    select{padding:6px 12px; border-radius: 4px; border: 1px solid #ccc;}
  </style>
</head>
<body>
  <h1>Seattle Rain Trends (Sea-Tac)</h1>
  <p class='sub'>Interactive visualization of NOAA precipitation data</p>
  
  <div class='wrap'>
    <div id="error-box" class='card note' style="display:none; background:#fff1f0; border-color:#ffa39e; color:#cf1322;">
        <strong>Error:</strong> Could not find CSV data. Ensure the GitHub Action has run successfully.
    </div>

    <div class='card'>
      <div style='display:flex; align-items:center; gap:12px; margin-bottom:8px;'>
        <label for='yearSel'><strong>Select Year for Monthly View:</strong></label>
        <select id='yearSel'></select>
      </div>
      <div id='monthlyChart' style='height:400px;'></div>
    </div>

    <div class='row'>
      <div class='card col'>
        <div id='annualTrend' style='height:400px;'></div>
      </div>
      <div class='card col'>
        <div id='monthlyHeat' style='height:400px;'></div>
      </div>
    </div>

    <div class='card' style="font-size: 0.85em; color: #777;">
      <strong>Data Source:</strong> NOAA Global Summary of the Month/Year (GSOM/GSOY). 
      <strong>Station:</strong> GHCND:USW00024233. 
      <em>Updated automatically via GitHub Actions.</em>
    </div>
  </div>

<script>
const MONTHS_ORDER = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
let monthlyData = [];
let annualData = [];

// Helper to parse NOAA's "YYYY-MM-DD" or "YYYY-MM" into usable parts
function processNoaaRow(row) {
    if (!row.date) return null;
    const dateParts = row.date.split('-');
    const year = parseInt(dateParts[0]);
    const monthIndex = parseInt(dateParts[1]) - 1;
    return {
        Year: year,
        Month: MONTHS_ORDER[monthIndex],
        Precip: parseFloat(row.value)
    };
}

function loadCSV(path){
  return new Promise((resolve,reject)=>{
    Papa.parse(path, {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: results => resolve(results.data),
      error: err => reject(err)
    });
  });
}

function initSelectors(){
  const sel = document.getElementById('yearSel');
  const years = Array.from(new Set(monthlyData.map(d=>d.Year))).sort((a,b)=>b-a);
  sel.innerHTML = years.map(y=>`<option value='${y}'>${y}</option>`).join('');
  sel.onchange = renderMonthly;
  if(years.length){ sel.value = years[0]; }
}

function renderMonthly(){
  const year = parseInt(document.getElementById('yearSel').value,10);
  const rows = monthlyData.filter(d=>d.Year===year);
  const monthMap = new Map(rows.map(r=>[r.Month, r.Precip]));
  
  const x = MONTHS_ORDER;
  const y = x.map(m=> monthMap.has(m) ? monthMap.get(m) : 0);

  const trace = { 
      x, y, 
      type:'bar', 
      marker:{color:'#1B98E0'}, 
      hovertemplate:'%{x}: %{y}"<extra></extra>' 
  };
  const layout = { 
      title:`Monthly Rainfall in ${year}`, 
      yaxis:{ title:'Inches' }, 
      margin:{l:50,r:20,t
