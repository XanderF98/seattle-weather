
name: Update Seattle Rain CSVs

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * 1"  # Mondays at 09:00 UTC

permissions:
  contents: write   # allow commit/push

jobs:
  fetch-noaa:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show repo tree (debug)
        shell: bash
        run: |
          echo "PWD: $(pwd)"
          echo "Top-level files:"
          ls -la
          echo "scripts/:"
          ls -la scripts || true
          echo "docs/:"
          ls -la docs || true
          echo "First lines of fetch script:"
          head -n 30 scripts/fetch_noaa_precip.py || true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Check NOAA token presence
        shell: bash
        env:
          NOAA_CDO_TOKEN: ${{ secrets.NOAA_CDO_TOKEN }}
        run: |
          if [ -z "${NOAA_CDO_TOKEN}" ]; then
            echo "NOAA_CDO_TOKEN is NOT set (create repo secret in Settings → Secrets and variables → Actions)."
            exit 1
          fi
          echo "NOAA_CDO_TOKEN is present."

      # Sanity test: use a quoted URL var to avoid YAML line folding issues
      - name: Sanity test the NOAA API (GSOM PRCP month)
        shell: bash
        env:
          NOAA_CDO_TOKEN: ${{ secrets.NOAA_CDO_TOKEN }}
        run: |
          set -e
          URL="https://www.ncei.noaa.gov/cdo-web/api/v2/data?datasetid=GSOM&datatypeid=PRCP&stationid=GHCND:USW00024233&startdate=2022-01-01&enddate=2022-12-31&units=standard&limit=5"
          echo "Testing NOAA CDO with URL:"
          echo "$URL"
          curl -sS -f -H "token: ${NOAA_CDO_TOKEN}" "$URL" >/dev/null
          echo "Sanity test returned HTTP 200."

      # Ensure end date is never blank for the script
      - name: Set end date env
        shell: bash
        run: echo "NOAA_END_DATE=$(date -u +%F)" >> "$GITHUB_ENV"

      - name: Fetch NOAA CSVs
        shell: bash
        env:
          NOAA_CDO_TOKEN: ${{ secrets.NOAA_CDO_TOKEN }}
          NOAA_START_DATE: "1991-01-01"
          # NOAA_END_DATE comes from $GITHUB_ENV (Set end date env)
        run: |
          set -e
          python scripts/fetch_noaa_precip.py

      - name: Show generated files (debug)
        shell: bash
        run: |
          echo "Workspace after fetch:"
          ls -la

      # Move generated CSVs into /docs so Pages can serve them
      - name: Move CSVs into docs for Pages
        shell: bash
        run: |
          set -e
          mkdir -p docs
          if [ -f seattle_rain_monthly.csv ]; then mv -f seattle_rain_monthly.csv docs/; fi
          if [ -f seattle_rain_annual.csv ]; then mv -f seattle_rain_annual.csv docs/; fi
          echo "docs/ contents:"
          ls -la docs

      - name: Commit changes (if any)
        shell: bash
        run: |
          set -e
          git config user.name "gh-actions"
          git config user.email "actions@github.com"

          ADDED=0
          if [ -f docs/seattle_rain_monthly.csv ]; then
            git add docs/seattle_rain_monthly.csv
            ADDED=1
          fi
          if [ -f docs/seattle_rain_annual.csv ]; then
            git add docs/seattle_rain_annual.csv
            ADDED=1
          fi

          if [ "$ADDED" -eq 1 ]; then
            if ! git diff --cached --quiet; then
              git commit -m "Auto-update: NOAA precipitation CSVs (docs)"
              git push
            else
              echo "No changes to commit."
            fi
          else
            echo "CSV files not found; nothing to commit."
          fi
