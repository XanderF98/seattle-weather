
name: Update Seattle Rain CSVs

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * 1"  # Mondays at 09:00 UTC

permissions:
  contents: write   # allow commit/push

jobs:
  fetch-noaa:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show repo tree (debug)
        shell: bash
        run: |
          echo "PWD: $(pwd)"
          echo "Top-level files:"
          ls -la
          echo "scripts/:"
          ls -la scripts || true
          echo "First lines of fetch script:"
          head -n 30 scripts/fetch_noaa_precip.py || true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Check NOAA token presence
        shell: bash
        env:
          NOAA_CDO_TOKEN: ${{ secrets.NOAA_CDO_TOKEN }}
        run: |
          if [ -z "${NOAA_CDO_TOKEN}" ]; then
            echo "NOAA_CDO_TOKEN is NOT set (create repo secret in Settings → Secrets and variables → Actions)."
            exit 1
          fi
          echo "NOAA_CDO_TOKEN is present."

      # Sanity test WITHOUT command substitution; just fail on non-200
      - name: Sanity test the NOAA API (GSOM PRCP month)
        shell: bash
        env:
          NOAA_CDO_TOKEN: ${{ secrets.NOAA_CDO_TOKEN }}
        run: |
          set -e
          curl -sS -f \
            -H "token: ${NOAA_CDO_TOKEN}" \
